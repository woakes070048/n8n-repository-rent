{
  "active": true,
  "connections": {
    "When clicking ‘Test workflow’": {
      "main": [
        [
          {
            "node": "FTP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FTP": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code1": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "MySQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "FTP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-03-20T10:22:17.696Z",
  "id": "klF6Q8mqIHH0jjUn",
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "2 - Process Unit Counts",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -720,
        -80
      ],
      "id": "0bde9549-aeaf-4669-8242-616fef360d7f",
      "name": "When clicking ‘Test workflow’"
    },
    {
      "parameters": {
        "path": "/public_html/data/rent_totals.csv"
      },
      "type": "n8n-nodes-base.ftp",
      "typeVersion": 1,
      "position": [
        -540,
        20
      ],
      "id": "9dde66a1-c168-4544-929e-5ab0a3a257fd",
      "name": "FTP",
      "credentials": {
        "ftp": {
          "id": "87ZwJT7N7b5rycj4",
          "name": "n8n Data FTP account"
        }
      }
    },
    {
      "parameters": {
        "operation": "xlsx",
        "options": {
          "rawData": true
        }
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        -380,
        20
      ],
      "id": "42fe97d5-ea7e-41b6-9663-7f12de6a88b0",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "jsCode": "// Ensure input data is available\nif (!items || items.length === 0) {\n    throw new Error(\"No input data found.\");\n}\n\n// Define statuses to count\nconst trackStatuses = [\"Current\", \"Vacant-Rented\", \"Vacant-Unrented\", \"Evict\"];\nconst today = new Date();\nconst propertyData = {};\n\nfunction parseDate(str) {\n    const parts = str.split(\"/\");\n    if (parts.length !== 3) return null;\n    const [month, day, year] = parts.map(p => parseInt(p, 10));\n    return new Date(year, month - 1, day); // Month is 0-based\n}\n\nitems.forEach(item => {\n    const json = item.json;\n\n    const propertyID = json[\"Property ID\"];\n    const propertyName = json[\"Property Name\"];\n    const unit = json[\"Unit\"];\n    const status = json[\"Status\"];\n    const leaseTo = json[\"Lease To\"];\n    const leaseExpiresMonth = json[\"Lease Expires Month\"];\n\n    if (!propertyID || !unit) return;\n\n    if (!propertyData[propertyID]) {\n        propertyData[propertyID] = {\n            \"Property Name\": propertyName,\n            \"Status Counts\": {},\n            \"Units By Status\": {},\n            \"Lease Expirations\": {\n                \"30 Days\": 0,\n                \"60 Days\": 0,\n                \"90 Days\": 0,\n                \"Month-To-Month\": 0\n            }\n        };\n    }\n\n    const prop = propertyData[propertyID];\n\n    // Count status\n    if (trackStatuses.includes(status)) {\n        if (!prop[\"Status Counts\"][status]) {\n            prop[\"Status Counts\"][status] = 0;\n            prop[\"Units By Status\"][status] = [];\n        }\n        prop[\"Status Counts\"][status]++;\n        prop[\"Units By Status\"][status].push(unit);\n    }\n\n    // Lease expirations\n    if (leaseTo && leaseTo.includes(\"/\")) {\n        const leaseDate = parseDate(leaseTo);\n        if (leaseDate) {\n            const diffDays = Math.ceil((leaseDate - today) / (1000 * 60 * 60 * 24));\n            if (diffDays > 0 && diffDays <= 30) {\n                prop[\"Lease Expirations\"][\"30 Days\"]++;\n            } else if (diffDays <= 60) {\n                prop[\"Lease Expirations\"][\"60 Days\"]++;\n            } else if (diffDays <= 90) {\n                prop[\"Lease Expirations\"][\"90 Days\"]++;\n            }\n        }\n    }\n\n    // Month-to-month\n    if (\n        leaseExpiresMonth &&\n        leaseExpiresMonth.toLowerCase().includes(\"month-to-month\")\n    ) {\n        prop[\"Lease Expirations\"][\"Month-To-Month\"]++;\n    }\n});\n\n// Format final output\nconst formatted = Object.entries(propertyData).map(([propertyID, data]) => ({\n    \"Property ID\": propertyID,\n    \"Property Name\": data[\"Property Name\"],\n    \"Status Counts\": data[\"Status Counts\"],\n    \"Units By Status\": data[\"Units By Status\"],\n    \"Lease Expirations\": data[\"Lease Expirations\"]\n}));\n\nreturn [{ json: { propertyData: formatted } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -200,
        20
      ],
      "id": "48d5282f-900a-4ab6-b394-77ecc71e74a6",
      "name": "Code"
    },
    {
      "parameters": {
        "jsCode": "// Ensure input data is available\nif (!items || items.length === 0 || !items[0].json.propertyData) {\n    throw new Error(\"No property data found.\");\n}\n\n// Extract the propertyData array\nconst properties = items[0].json.propertyData;\n\n// Convert each property object into an individual item\nconst output = properties.map(property => {\n    const currentUnits = property[\"Units By Status\"][\"Current\"] || [];\n    const vacantUnrentedUnits = property[\"Units By Status\"][\"Vacant-Unrented\"] || [];\n    const vacantRentedUnits = property[\"Units By Status\"][\"Vacant-Rented\"] || [];\n    const evictUnits = property[\"Units By Status\"][\"Evict\"] || [];\n    const noticeRentedUnits = property[\"Units By Status\"][\"Notice Rented\"] || [];\n    const noticeUnrentedUnits = property[\"Units By Status\"][\"Notice-Unrented\"] || [];\n\n    const statusCounts = property[\"Status Counts\"] || {};\n    const leaseExpirations = property[\"Lease Expirations\"] || {};\n\n    return {\n        json: {\n            \"Property ID\": property[\"Property ID\"],\n            \"Property Name\": property[\"Property Name\"],\n\n            // Status Counts\n            \"Current Count\": statusCounts[\"Current\"] || 0,\n            \"Vacant-Rented Count\": statusCounts[\"Vacant-Rented\"] || 0,\n            \"Vacant-Unrented Count\": statusCounts[\"Vacant-Unrented\"] || 0,\n            \"Notice-Rented Count\": statusCounts[\"Notice Rented\"] || 0,\n            \"Notice-Unrented Count\": statusCounts[\"Notice-Unrented\"] || 0,\n            \"Notice-Eviction Count\": statusCounts[\"Evict\"] || 0,\n\n            // Unit Lists\n            \"Current\": currentUnits.join(\", \"),\n            \"Vacant-Rented\": vacantRentedUnits.join(\", \"),\n            \"Vacant-Unrented\": vacantUnrentedUnits.join(\", \"),\n            \"Notice-Rented\": noticeRentedUnits.join(\", \"),\n            \"Notice-Unrented\": noticeUnrentedUnits.join(\", \"),\n            \"Notice-Eviction\": evictUnits.join(\", \"),\n\n            // Lease Expiration Counts\n            \"Lease Expiring in 30 Days\": leaseExpirations[\"30 Days\"] || 0,\n            \"Lease Expiring in 60 Days\": leaseExpirations[\"60 Days\"] || 0,\n            \"Lease Expiring in 90 Days\": leaseExpirations[\"90 Days\"] || 0,\n            \"Lease Month-To-Month\": leaseExpirations[\"Month-To-Month\"] || 0\n        }\n    };\n});\n\n// Return the processed data for n8n\nreturn output;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        20,
        20
      ],
      "id": "280a689c-3487-44ef-a9ba-1177468b2916",
      "name": "Code1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "81445d00-913c-4ce9-b8e4-4e54a44f5fa5",
              "name": "property_id",
              "value": "={{ $json[\"Property ID\"] }}",
              "type": "string"
            },
            {
              "id": "8b16bfd3-d496-41d1-88e1-c96ff238bfbd",
              "name": "vacant_rented_count",
              "value": "={{ $json[\"Vacant-Rented Count\"] }}",
              "type": "number"
            },
            {
              "id": "97c2ce4f-6cde-4103-92fd-02bf6183734e",
              "name": "vacant_unrented_count",
              "value": "={{ $json[\"Vacant-Unrented Count\"] }}",
              "type": "number"
            },
            {
              "id": "6475385c-c953-47cd-9c52-946019a464dd",
              "name": "notice_rented_count",
              "value": "={{ $json[\"Notice-Rented Count\"] }}",
              "type": "number"
            },
            {
              "id": "3439a863-8084-4429-8cbd-dcd7e611895f",
              "name": "notice_unrented_count",
              "value": "={{ $json[\"Notice-Unrented Count\"] }}",
              "type": "number"
            },
            {
              "id": "e9cb9167-a8a8-47f2-ae95-734536820b22",
              "name": "vacant_unrented_json",
              "value": "={{ $json['Vacant-Unrented'] || \"None\"}}",
              "type": "string"
            },
            {
              "id": "dc040be4-8e04-4914-9b0d-c459c614a8be",
              "name": "vacant_rented_json",
              "value": "={{ $json['Vacant-Rented'] || \"None\"}}",
              "type": "string"
            },
            {
              "id": "13c21479-e63a-41fe-8daf-94d9cd570012",
              "name": "notice_unrented_json",
              "value": "={{ $json[\"Notice-Unrented\"] || \"None\"}} ",
              "type": "string"
            },
            {
              "id": "a5e03d3c-06df-428a-aacd-3855cd698b7e",
              "name": "notice_rented_json",
              "value": "={{ $json[\"Notice-Rented\"] || 0}}",
              "type": "string"
            },
            {
              "id": "991771e6-43ef-4c17-aa70-863f54c9812c",
              "name": "Notice-Eviction Count",
              "value": "={{ $json['Notice-Eviction Count'] }}",
              "type": "number"
            },
            {
              "id": "31a18c46-b814-483c-a091-a8d05dbf9781",
              "name": "Vacant-Unrented",
              "value": "={{ $json['Vacant-Unrented'] }}",
              "type": "string"
            },
            {
              "id": "4dcc177e-c469-434e-b54c-32918c65257e",
              "name": "Notice-Eviction",
              "value": "={{ $json[\"Notice-Eviction\"] }}",
              "type": "string"
            },
            {
              "id": "37d7f7de-4d47-49f4-a410-dae0b41e1f2b",
              "name": "lease_30",
              "value": "={{ $json[\"Lease Expiring in 30 Days\"] }}",
              "type": "string"
            },
            {
              "id": "7de3dc47-8d53-41d6-bf0e-40512e6a7e95",
              "name": "lease_60",
              "value": "={{ $json[\"Lease Expiring in 60 Days\"] }}",
              "type": "number"
            },
            {
              "id": "9ce3eaea-e105-41bd-ae20-bfc58fc28bb0",
              "name": "lease_90",
              "value": "={{ $json[\"Lease Expiring in 90 Days\"] }}",
              "type": "string"
            },
            {
              "id": "bd2fff89-2b36-43c4-b92a-bb020ccc1d2f",
              "name": "lease_m2m",
              "value": "={{ $json[\"Lease Month-To-Month\"] }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        240,
        20
      ],
      "id": "c0e07e64-599b-4b57-8a84-3e201f808b04",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "operation": "upsert",
        "table": {
          "__rl": true,
          "value": "daily_data",
          "mode": "list",
          "cachedResultName": "daily_data"
        },
        "dataMode": "defineBelow",
        "columnToMatchOn": "property_id",
        "valueToMatchOn": "={{ $json.property_id }}",
        "valuesToSend": {
          "values": [
            {
              "column": "vacant_rented_count",
              "value": "={{ $json.vacant_rented_count }}"
            },
            {
              "column": "vacant_unrented_count",
              "value": "={{ $json.vacant_unrented_count }}"
            },
            {
              "column": "notice_rented_count",
              "value": "={{ $json.notice_rented_count }}"
            },
            {
              "column": "notice_unrented_count",
              "value": "={{ $json.notice_unrented_count }}"
            },
            {
              "column": "vacant_unrented_json",
              "value": "={{ $json.vacant_unrented_json }}"
            },
            {
              "column": "vacant_rented_json",
              "value": "={{ $json.vacant_rented_json }}"
            },
            {
              "column": "notice_unrented_json",
              "value": "={{ $json.vacant_unrented_json }}"
            },
            {
              "column": "vacant_rented_json",
              "value": "={{ $json.notice_rented_json }}"
            },
            {
              "column": "notice_eviction_count",
              "value": "={{ $json[\"Notice-Eviction Count\"] }}"
            },
            {
              "column": "vacant_unrented_json",
              "value": "={{ $json[\"Vacant-Unrented\"] }}"
            },
            {
              "column": "notice_eviction",
              "value": "={{ $json[\"Notice-Eviction\"] }}"
            },
            {
              "column": "lease_30",
              "value": "={{ $json.lease_30 }}"
            },
            {
              "column": "lease_60",
              "value": "={{ $json.lease_60 }}"
            },
            {
              "column": "lease_90"
            },
            {
              "column": "lease_m2m",
              "value": "={{ $json.lease_m2m }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.4,
      "position": [
        460,
        20
      ],
      "id": "481122dc-0843-4c13-8cf8-dfd0a993b5df",
      "name": "MySQL",
      "credentials": {
        "mySql": {
          "id": "OUIfR0k9k0YXHa0V",
          "name": "Blazedata Hostinger"
        }
      }
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "triggerAtHour": 6,
              "triggerAtMinute": 5
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -720,
        120
      ],
      "id": "254b0f7d-3d7a-43f3-8c75-ffe994c7ff28",
      "name": "Schedule Trigger"
    }
  ],
  "pinData": {},
  "settings": {
    "executionOrder": "v1",
    "errorWorkflow": "Etm1h3dHXQYzby5C"
  },
  "staticData": {
    "node:Schedule Trigger": {
      "recurrenceRules": []
    }
  },
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-03-21T15:01:36.000Z",
  "versionId": "8f51195b-29d6-4f83-82f3-2b7a47208c95"
}
{
  "active": true,
  "connections": {
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Execute Workflow",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTML": {
      "main": [
        [
          {
            "node": "Gmail",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Group Current vs Last Week Data": {
      "main": [
        [
          {
            "node": "Calculate Deltas & Icons",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculate Deltas & Icons": {
      "main": [
        [
          {
            "node": "Format Lead Sources HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Lead Sources HTML": {
      "main": [
        [
          {
            "node": "HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Active Properties": {
      "main": [
        [
          {
            "node": "Group Current vs Last Week Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute Workflow": {
      "main": [
        [
          {
            "node": "Get Active Properties",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-04-05T16:07:09.980Z",
  "id": "2onG2wWXHUpCfysW",
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "Weekly Property Performance Email",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "weeks",
              "triggerAtDay": [
                1
              ],
              "triggerAtHour": 7
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -580,
        -80
      ],
      "id": "70789de5-7665-4038-8bf7-c9101221a505",
      "name": "Schedule Trigger"
    },
    {
      "parameters": {
        "resource": "draft",
        "subject": "=Your Property Marketing Performance for {{ $('Calculate Deltas & Icons').item.json.property_name }}",
        "emailType": "html",
        "message": "={{ $json.html }}",
        "options": {
          "sendTo": "={{ $('Calculate Deltas & Icons').item.json.owner_email }}"
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        960,
        -80
      ],
      "id": "df681893-147f-4bc6-9b21-f2a88000184e",
      "name": "Gmail",
      "webhookId": "670979d2-614a-4484-bf1c-f610a80fcffb",
      "credentials": {
        "gmailOAuth2": {
          "id": "LD5x69eYRRI6cdrn",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "html": "<!DOCTYPE html>\n<html>\n  <body style=\"margin:0; padding:0; font-family: Arial, sans-serif; background-color: #f4f6f8; color: #2c3e50;\">\n    <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"background-color: #f4f6f8;\">\n      <tr>\n        <td align=\"center\">\n          <table width=\"700\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"background-color: #ffffff; border-radius: 12px; overflow: hidden; margin: 20px auto; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);\">\n            \n            <!-- Header -->\n            <tr>\n              <td align=\"center\" style=\"background: linear-gradient(90deg, #ff6600, #ff3300); padding: 30px; border-radius: 12px 12px 0 0;\">\n                <img src=\"https://blazeproperty.com/wp-content/uploads/elementor/thumbs/Blaze-Logo@0.5x-r0a9ey5glgo1fw9bih58md769hk4ii44j6idfvlvy8.png\" alt=\"Blaze Logo\" style=\"max-height: 60px; margin-bottom: 10px;\" />\n                <h2 style=\"margin: 0; font-size: 22px; color: #fff;\">Weekly Property Performance Summary</h2>\n              </td>\n            </tr>\n\n            <!-- Beta Welcome Message -->\n            <tr>\n              <td style=\"padding: 20px 30px 10px;\">\n                <div style=\"background-color: #fff3e0; border-left: 5px solid #ff9900; padding: 15px 20px; font-size: 14px; line-height: 1.5;\">\n                  <strong>Welcome!</strong> This summary is part of our new owner reporting initiative.\n                  Itâ€™s currently in <em>beta</em>, and we welcome your feedback. Send suggestions to\n                  <a href=\"mailto:brandon@blazeproperty.com\" style=\"color: #d35400;\">brandon@blazeproperty.com</a>.\n                </div>\n              </td>\n            </tr>\n\n            <!-- Property Info -->\n            <tr>\n              <td style=\"padding: 10px 30px 0;\">\n                <p style=\"font-size: 16px; font-weight: bold; margin: 0;\">Property: {{ $json.property_name }}</p>\n              </td>\n            </tr>\n\n            <!-- Metrics Table -->\n            <tr>\n              <td style=\"padding: 0 30px 30px;\">\n                <table width=\"100%\" cellpadding=\"10\" cellspacing=\"0\" border=\"0\" style=\"border-collapse: collapse; width: 100%; text-align: center;\">\n                  <tr style=\"background-color: #ffe5d1; font-weight: bold;\">\n                    <td style=\"border: 1px solid #ddd;\">Metric</td>\n                    <td style=\"border: 1px solid #ddd;\">Last Week</td>\n                    <td style=\"border: 1px solid #ddd;\">This Week</td>\n                    <td style=\"border: 1px solid #ddd;\">Change</td>\n                  </tr>\n                  <tr style=\"background-color: #ffffff;\">\n                    <td style=\"border: 1px solid #ddd;\">Guest Cards</td>\n                    <td style=\"border: 1px solid #ddd;\">{{ $json.guest_cards_last }}</td>\n                    <td style=\"border: 1px solid #ddd;\">{{ $json.guest_cards_current }}</td>\n                    <td style=\"border: 1px solid #ddd;\">{{ $json.guest_cards_icon }} {{ $json.guest_cards_delta }}</td>\n                  </tr>\n                  <tr style=\"background-color: #fafafa;\">\n                    <td style=\"border: 1px solid #ddd;\">Applications</td>\n                    <td style=\"border: 1px solid #ddd;\">{{ $json.applications_last }}</td>\n                    <td style=\"border: 1px solid #ddd;\">{{ $json.applications_current }}</td>\n                    <td style=\"border: 1px solid #ddd;\">{{ $json.applications_icon }} {{ $json.applications_delta }}</td>\n                  </tr>\n                  <tr style=\"background-color: #ffffff;\">\n                    <td style=\"border: 1px solid #ddd;\">Showings</td>\n                    <td style=\"border: 1px solid #ddd;\">{{ $json.showings_last }}</td>\n                    <td style=\"border: 1px solid #ddd;\">{{ $json.showings_current }}</td>\n                    <td style=\"border: 1px solid #ddd;\">{{ $json.showings_icon }} {{ $json.showings_delta }}</td>\n                  </tr>\n                  <tr style=\"background-color: #fafafa;\">\n                    <td style=\"border: 1px solid #ddd;\">Showings Cancelled</td>\n                    <td style=\"border: 1px solid #ddd;\">{{ $json.showings_cancelled_last }}</td>\n                    <td style=\"border: 1px solid #ddd;\">{{ $json.showings_cancelled_current }}</td>\n                    <td style=\"border: 1px solid #ddd;\">{{ $json.showings_cancelled_icon }} {{ $json.showings_cancelled_delta }}</td>\n                  </tr>\n                </table>\n              </td>\n            </tr>\n\n            <!-- Lead Sources -->\n            <tr>\n              <td style=\"padding: 0 30px 20px;\">\n                <h4 style=\"color: #e67e22; font-size: 16px; margin: 0 0 8px;\">This Weekâ€™s Lead Sources</h4>\n                {{ $json.lead_sources_html }}\n              </td>\n            </tr>\n\n            <!-- Upcoming Showings -->\n            <tr>\n              <td style=\"padding: 0 30px 30px;\">\n                <h4 style=\"color: #e67e22; font-size: 16px; margin: 0 0 8px;\">Upcoming Showings</h4>\n                {{ $json.upcoming_showings_html }}\n              </td>\n            </tr>\n\n            <!-- Footer -->\n            <tr>\n              <td align=\"center\" style=\"padding: 20px; font-size: 12px; color: #888; border-top: 1px solid #eee;\">\n                This report is automatically generated by Blaze Real Estateâ€™s reporting system.<br />\n                For questions, contact <a href=\"mailto:brandon@blazeproperty.com\" style=\"color: #d35400;\">brandon@blazeproperty.com</a>\n              </td>\n            </tr>\n            \n          </table>\n        </td>\n      </tr>\n    </table>\n  </body>\n</html>\n"
      },
      "type": "n8n-nodes-base.html",
      "typeVersion": 1.2,
      "position": [
        740,
        -80
      ],
      "id": "744662d3-4948-4831-928f-5a4fb09247b3",
      "name": "HTML"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst grouped = {};\n\nfor (const item of items) {\n  const {\n    property_id,\n    property_name,\n    owner_id,\n    owner_email,\n    week_ending,\n    ...metrics\n  } = item.json;\n\n  if (!grouped[property_id]) {\n    grouped[property_id] = {\n      property_id,\n      property_name,\n      owner_id,\n      owner_email,\n      current: null,\n      last: null,\n    };\n  }\n\n  const slot = (grouped[property_id].current === null) ? 'current' : 'last';\n  grouped[property_id][slot] = metrics;\n}\n\nreturn Object.values(grouped).map(({ property_id, property_name, owner_id, owner_email, current, last }) => ({\n  json: {\n    property_id,\n    property_name,\n    owner_id,\n    owner_email,\n    guest_cards_current: current?.guest_cards || 0,\n    guest_cards_last: last?.guest_cards || 0,\n    applications_current: current?.applications || 0,\n    applications_last: last?.applications || 0,\n    showings_current: current?.showings || 0,\n    showings_last: last?.showings || 0,\n    showings_cancelled_current: current?.showings_cancelled || 0,\n    showings_cancelled_last: last?.showings_cancelled || 0,\n    lead_sources_current: current?.lead_sources || '{}',\n    lead_sources_last: last?.lead_sources || '{}',\n    application_statuses_current: current?.application_statuses || '{}',\n    application_statuses_last: last?.application_statuses || '{}',\n  }\n}));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        80,
        -80
      ],
      "id": "c993a3e5-e9f1-4e82-b317-dd8e5819ab5b",
      "name": "Group Current vs Last Week Data"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const item = $input.item.json;\n\nfunction getDeltaDetails(current, last) {\n  const delta = current - last;\n  const symbol = delta === 0 ? \"Â±\" : delta > 0 ? \"+\" : \"\";\n  const icon = delta === 0 ? \"âž–\" : delta > 0 ? \"ðŸ“ˆ\" : \"ðŸ“‰\";\n  const color = delta === 0 ? \"#6c757d\" : delta > 0 ? \"#28a745\" : \"#dc3545\"; // gray, green, red\n  return {\n    delta: `${symbol}${delta}`,\n    icon,\n    color\n  };\n}\n\nconst guestCards = getDeltaDetails(item.guest_cards_current, item.guest_cards_last);\nconst applications = getDeltaDetails(item.applications_current, item.applications_last);\nconst showings = getDeltaDetails(item.showings_current, item.showings_last);\nconst showingsCancelled = getDeltaDetails(item.showings_cancelled_current, item.showings_cancelled_last);\n\nreturn {\n  json: {\n    ...item,\n    guest_cards_delta: guestCards.delta,\n    guest_cards_icon: guestCards.icon,\n    guest_cards_color: guestCards.color,\n\n    applications_delta: applications.delta,\n    applications_icon: applications.icon,\n    applications_color: applications.color,\n\n    showings_delta: showings.delta,\n    showings_icon: showings.icon,\n    showings_color: showings.color,\n\n    showings_cancelled_delta: showingsCancelled.delta,\n    showings_cancelled_icon: showingsCancelled.icon,\n    showings_cancelled_color: showingsCancelled.color\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        300,
        -80
      ],
      "id": "45fed572-84dd-4c26-bbd4-542bfd0fb8fa",
      "name": "Calculate Deltas & Icons"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const sources = JSON.parse($json.lead_sources_current || '{}');\n\nlet sourcesHTML = '';\nfor (const [source, count] of Object.entries(sources)) {\n  sourcesHTML += `<li><strong>${source}:</strong> ${count}</li>`;\n}\n\n// Assume upcoming_showings is a number or string; update if you have richer data\nlet upcomingHTML = '';\nif ($json.upcoming_showings && $json.upcoming_showings > 0) {\n  upcomingHTML = `<p><strong>ðŸ“… Upcoming Showings:</strong> ${$json.upcoming_showings}</p>`;\n} else {\n  upcomingHTML = `<p><em>Looks quiet now, but weâ€™re just one click away from a showing request. ðŸ“…</em></p>`;\n}\n\nreturn {\n  json: {\n    ...$json,\n    lead_sources_current_parsed: sources,\n    lead_sources_html: `<ul>${sourcesHTML}</ul>`,\n    upcoming_showings_html: upcomingHTML,\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        520,
        -80
      ],
      "id": "f51f835d-59cf-45ab-aa33-f13b086a2224",
      "name": "Format Lead Sources HTML"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  oms.property_id,\n  oms.property_name,\n  oms.owner_id,\n  oms.owner_email,\n  oms.guest_cards,\n  oms.applications,\n  oms.showings,\n  oms.showings_cancelled,\n  oms.lead_sources,\n  oms.application_statuses,\n  oms.week_ending\nFROM owner_marketing_summary oms\nJOIN (\n  SELECT DISTINCT week_ending \n  FROM owner_marketing_summary \n  ORDER BY week_ending DESC \n  LIMIT 2\n) recent_weeks ON oms.week_ending = recent_weeks.week_ending\nORDER BY oms.property_id, oms.week_ending DESC;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.4,
      "position": [
        -140,
        -80
      ],
      "id": "9e65f498-b38e-42f2-ae8e-ac98eee0e364",
      "name": "Get Active Properties",
      "credentials": {
        "mySql": {
          "id": "OUIfR0k9k0YXHa0V",
          "name": "Blazedata Hostinger"
        }
      }
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "TE8BPSUM26yF59XY",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        -360,
        -80
      ],
      "id": "60631404-a510-41b1-b167-a784c524eb25",
      "name": "Execute Workflow"
    }
  ],
  "pinData": {},
  "settings": {
    "executionOrder": "v1",
    "errorWorkflow": "Etm1h3dHXQYzby5C"
  },
  "staticData": {
    "node:Schedule Trigger": {
      "recurrenceRules": []
    }
  },
  "tags": [
    {
      "createdAt": "2025-03-08T13:24:58.615Z",
      "updatedAt": "2025-03-08T13:24:58.615Z",
      "id": "9NBFp5smMq2uf5oA",
      "name": "Email Processing"
    },
    {
      "createdAt": "2024-07-29T13:51:51.785Z",
      "updatedAt": "2024-07-29T13:51:51.785Z",
      "id": "JYvoNb6Xp7LdO4GE",
      "name": "MySQL"
    },
    {
      "createdAt": "2025-04-06T12:19:17.588Z",
      "updatedAt": "2025-04-06T12:19:17.588Z",
      "id": "W05IJGKJx5hczKHB",
      "name": "rep-email-owner"
    },
    {
      "createdAt": "2025-04-06T12:17:13.094Z",
      "updatedAt": "2025-04-06T12:17:13.094Z",
      "id": "YeEleillKvhm73X6",
      "name": "Reports"
    },
    {
      "createdAt": "2025-04-06T12:17:17.452Z",
      "updatedAt": "2025-04-06T12:17:17.452Z",
      "id": "iMY7dbCfswxr2yQJ",
      "name": "Owner"
    }
  ],
  "triggerCount": 1,
  "updatedAt": "2025-04-06T12:22:51.000Z",
  "versionId": "c832fd8f-6c2d-45d9-a217-2d691824fa1a"
}